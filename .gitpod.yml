image:
  file: .gitpod.Dockerfile

tasks:
  - name: RAG Startup
    # Use 'before' for setup that should happen before the main command
    before: |
      # Verify environment
      echo "ğŸŒ± Environment: PIP_CACHE_DIR=$PIP_CACHE_DIR, UV_CACHE_DIR=$UV_CACHE_DIR"
      echo "ğŸ Python version: $(python --version)"
      echo "âš¡ UV version: $(uv --version)"
    
    init: |
      echo "ğŸš€ Initializing LEGO RAG Environment..."
      
      # Activate virtual environment
      source .venv/bin/activate || {
        echo "ğŸ”§ Creating virtual environment..."
        uv venv
        source .venv/bin/activate
      }
      
      # Install/update dependencies (only if needed)
      echo "ğŸ“¦ Installing dependencies..."
      uv sync --frozen
      
      # Load data
      echo "ğŸ“Š Loading data..."
      python load_data.py
      
      echo "âœ… Initialization complete!"
    
    command: |
      echo "ğŸ¯ Starting Streamlit App..."
      source .venv/bin/activate
      streamlit run app.py --server.port 8080 --server.address 0.0.0.0

ports:
  - port: 8080
    onOpen: open-preview
    visibility: public

# Persist cache directories across workspace restarts
workspaceLocation: "/workspace"
checkoutLocation: "."

vscode:
  extensions:
    - ms-python.python
    - ms-python.black-formatter
    - ms-python.flake8

# Git configuration for better performance
gitConfig:
  core.preloadindex: "true"
  core.fscache: "true"
  gc.auto: "256"