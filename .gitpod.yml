image:
  file: .gitpod.Dockerfile

tasks:
  - name: Health Check
    command: |
      echo "ğŸ¥ Running Health Checks..."
      source .venv/bin/activate
      
      # Quick import tests
      python -c "import streamlit, langchain, faiss, duckdb; print('âœ… Core imports OK')" || echo "âŒ Core imports failed"
      python -c "import app; print('âœ… App module OK')" || echo "âŒ App module failed"
      
      # Database connection test
      python -c "import duckdb; conn = duckdb.connect('lego_data.duckdb'); print('âœ… Database OK')" || echo "âŒ Database failed"
      
      # Environment check
      python -c "import os; print(f'âœ… Environment: RAG_MODE={os.getenv(\"RAG_MODE\", \"not set\")}')" || echo "âŒ Environment check failed"
      
      # Run comprehensive debug check (optional)
      echo "ğŸ” Running comprehensive system check..."
      python debug_setup.py || echo "âš ï¸ Debug check had issues (non-critical)"
      
      echo "ğŸ¥ Health check complete!"

  - name: RAG Startup
    # Use 'before' for setup that should happen before the main command
    before: |
      # Verify environment
      echo "ğŸŒ± Environment: PIP_CACHE_DIR=$PIP_CACHE_DIR, UV_CACHE_DIR=$UV_CACHE_DIR"
      echo "ğŸ Python version: $(python --version)"
      echo "âš¡ UV version: $(uv --version)"
    
    init: |
      echo "ğŸš€ Initializing LEGO RAG Environment..."
      
      # Activate virtual environment
      source .venv/bin/activate || {
        echo "ğŸ”§ Creating virtual environment..."
        uv venv
        source .venv/bin/activate
      }
      
      # Install/update dependencies (only if needed)
      echo "ğŸ“¦ Installing dependencies..."
      uv sync --frozen
      
      # Check if data already exists
      if [ -f "lego_data.duckdb" ] && [ -d "faiss_index" ]; then
        echo "âœ… Database and FAISS index found - skipping data loading!"
      else
        echo "ğŸ“Š Loading data..."
        python load_data.py
        
        echo "ğŸ” Creating FAISS index..."
        python fix_faiss.py
      fi
      
      echo "âœ… Initialization complete!"
    
    command: |
      echo "ğŸ¯ Starting Streamlit App..."
      source .venv/bin/activate
      streamlit run app.py --server.port 8080 --server.address 0.0.0.0

ports:
  - port: 8080
    onOpen: open-preview
    visibility: public

# Persist cache directories across workspace restarts
workspaceLocation: "/workspace"
checkoutLocation: "."

vscode:
  extensions:
    - ms-python.python
    - ms-python.black-formatter
    - ms-python.flake8

# Git configuration for better performance
gitConfig:
  core.preloadindex: "true"
  core.fscache: "true"
  gc.auto: "256"